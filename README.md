# AI Content Generation Backend

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ fal.ai. –ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –µ—Å—Ç—å –º–æ–¥–µ–ª—å –±–∞–ª–∞–Ω—Å–∞ –∏ —Ç–æ–∫–µ–Ω–æ–≤, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ webhook, —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∏ —á–∏—Å—Ç–∞—è –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (domain ‚Üí application ‚Üí infrastructure ‚Üí presentation).

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –í—ã–¥–∞—á–∞ –∏ —Ä–æ—Ç–∞—Ü–∏—è API-–∫–ª—é—á–µ–π (`/auth`).
- –£—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ ledger —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (credit/debit/refund) –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/balance`.
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É webhook (`/webhook/topup`), –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `X-Event-Id`.
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ fal.ai –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –±—Ä–æ–∫–µ—Ä–∞ (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ FastAPI).
- –°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ `job_id`; –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ < 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ HTTP-—Å–ª–æ–µ.

## üóÇÔ∏è –°—Ç–µ–∫
- **FastAPI** + **uvicorn** ‚Äî HTTP API –∏ —Å—Ö–µ–º–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤.
- **PostgreSQL** + **SQLAlchemy** + **alembic** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∑–∞–¥–∞—á –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
- **asyncio** ‚Äî —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–π –æ—á–µ—Ä–µ–¥–∏.
- **fal.ai** ‚Äî —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–≤–∏–¥–µ–æ.
- **Docker Compose** ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (API + PostgreSQL).

## üì¶ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –≤ Docker
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   cd ai-generation
   cp .env.example .env
   ```
3. –°–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker compose up --build
   ```
   –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `api` —Å–∞–º –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (`entrypoint.sh`) –∏ –ø–æ–¥–Ω–∏–º–µ—Ç FastAPI –Ω–∞ `http://localhost:8000`.

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:
   ```bash
   curl -i http://localhost:8000/healthz
   ```
https://github.com/Artur234rte/ai-generation
Swagger-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ `http://localhost:8000/docs`, ReDoc ‚Äî –Ω–∞ `http://localhost:8000/redoc`.

## üõ†Ô∏è –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ PostgreSQL —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.

```bash
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements-dev.txt
cp .env.example .env
pytest -q
pre-commit run --all-files
```

> –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é: `alembic upgrade head` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `alembic.ini` –∏ `DATABASE_URL` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è).

## üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
| –ò–º—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- |
| `DATABASE_URL` | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è asyncpg). |
| `FAL_KEY` | –ö–ª—é—á API fal.ai. |
| `PAYMENT_WEBHOOK_SECRET` | –°–µ–∫—Ä–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ–±—Ö—É–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (`X-Webhook-Secret`). |
| `TOKEN_PRICES_JSON` | JSON —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. |
| `POSTGRES_USER` / `POSTGRES_PASSWORD` / `POSTGRES_DB` | –£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ PostgreSQL (Docker). |

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —á–µ—Ä–µ–∑ `.env`; –¥–ª—è Docker Compose –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∞–∫–∂–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- `app/domain` ‚Äî —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞.
- `app/application` ‚Äî use-case –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
- `app/infrastructure` ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–ª–∏–µ–Ω—Ç—ã fal.ai, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏.
- `app/presentation` ‚Äî FastAPI, —Å—Ö–µ–º—ã –∏ —Ä–æ—É—Ç–µ—Ä—ã.
- `alembic/` ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î.
- `entrypoint.sh` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## üö¶ –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
–í—Å–µ POST-–æ–ø–µ—Ä–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `202 Accepted` –∏ `job_id`; —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `GET /generations/{job_id}`.

- **–ü–æ–ª—É—á–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å API-–∫–ª—é—á:** `POST /auth`
  ```bash
  curl -X POST http://localhost:8000/auth \
    -H "Content-Type: application/json" \
    -d '{"external_user_id": "<uuid>", "rotate": false}'
  ```
- **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å:** `GET /balance` (–∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-API-Key` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω).
- **–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (webhook):**
  ```bash
  curl -X POST http://localhost:8000/webhook/topup \
    -H "Content-Type: application/json" \
    -H "X-Webhook-Secret: $PAYMENT_WEBHOOK_SECRET" \
    -H "X-Event-Id: evt-123" \
    -d '{"external_user_id": "<uuid>", "amount": 100}'
  ```
- **Text ‚Üí Image:** `POST /generations/images/text-to-image`
- **Image + prompt ‚Üí Image:** `POST /generations/images/image-to-image`
- **Text ‚Üí Video:** `POST /generations/videos/text-to-video`
- **Image + prompt ‚Üí Video:** `POST /generations/videos/image-to-video`
- **–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á:** `GET /generations?limit=20&offset=0`
- **–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏:** `POST /generations/{job_id}/cancel`

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
curl -X GET http://localhost:8000/generations/<job_id> -H "X-API-Key: <api_key>"
```

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
- –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `asyncio.create_task` –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ API (—Å–º. `app.infrastructure.background`).
- –û—à–∏–±–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ polling –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ fal.ai –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –≤–æ–∑–≤—Ä–∞—Ç—É —Ç–æ–∫–µ–Ω–æ–≤ (refund) –∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏.
- –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –ø–æ–¥–Ω—è—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏–ª–∏ –Ω–æ–≤—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ–≥–æ–≤–æ—Ä–∫–∏
- –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∏–≤—ë—Ç –≤–Ω—É—Ç—Ä–∏ API-–ø—Ä–æ—Ü–µ—Å—Å–∞; –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –≤–æ—Ä–∫–µ—Ä –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á.
- HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–µ –¥–æ–∂–∏–¥–∞—é—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∏ –ø–ª–∞–Ω–∏—Ä—É—é—Ç –∑–∞–¥–∞—á—É.
- –ü—Ä–æ–µ–∫—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –¥–µ–º–æ/—Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –∏ –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
